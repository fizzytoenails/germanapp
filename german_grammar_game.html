<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>DeutscheTag | Sentence Match</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&family=Playfair+Display:wght@500;600&display=swap');
        :root {
            --bg: linear-gradient(135deg, #f7f4ff 0%, #f9f6ef 45%, #eef5ff 100%);
            --card: #ffffff;
            --ink: #0f172a;
            --muted: #64748b;
            --accent: #6d4bff;
            --accent-2: #2b72ff;
            --soft: rgba(109, 75, 255, 0.12);
            --shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
            --soft-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
            --radius-lg: 24px;
            --radius-md: 16px;
            --border: rgba(148, 163, 184, 0.2);
            --success: #16a34a;
            --danger: #dc2626;
        }
        body.theme-dark {
            --bg: linear-gradient(135deg, #0b1120 0%, #0f172a 45%, #111827 100%);
            --card: #101827;
            --ink: #e2e8f0;
            --muted: #94a3b8;
            --accent: #8b5cf6;
            --accent-2: #38bdf8;
            --soft: rgba(139, 92, 246, 0.18);
            --shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
            --soft-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
            --border: rgba(148, 163, 184, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            min-height: 100vh;
            background: var(--bg);
            font-family: 'Manrope', 'Segoe UI', sans-serif;
            color: var(--ink);
            display: flex;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
            touch-action: pan-y;
        }
        .container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; gap: 18px; }
        .nav {
            position: relative;
            background: rgba(255, 255, 255, 0.82);
            border-radius: var(--radius-lg);
            padding: 12px 18px;
            box-shadow: var(--soft-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
        }
        .brand { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; }
        .brand img { width: 44px; height: 44px; border-radius: 14px; box-shadow: 0 8px 18px rgba(109, 75, 255, 0.2); }
        .brand h1 { font-family: 'Playfair Display', serif; font-size: clamp(1.2rem, 2.4vw, 1.8rem); }
        .menu-toggle {
            display: inline-flex;
            border: none;
            background: rgba(148, 163, 184, 0.2);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            gap: 4px;
            flex-direction: column;
            position: absolute;
            right: 16px;
            top: 16px;
            z-index: 40;
        }
        .menu-toggle span { width: 20px; height: 2px; background: var(--ink); border-radius: 999px; display: block; }
        .nav-links {
            display: none;
            position: absolute;
            right: 16px;
            top: 68px;
            flex-direction: column;
            align-items: stretch;
            background: var(--card);
            padding: 12px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--soft-shadow);
            z-index: 50;
            min-width: 200px;
        }
        .nav-links.open { display: flex; }
        .nav-links a { text-decoration: none; color: var(--muted); padding: 8px 12px; border-radius: 999px; font-weight: 600; }
        .nav-links a.active, .nav-links a:hover { background: var(--soft); color: var(--accent); }
        .nav-actions { margin-right: 68px; display: flex; align-items: center; width: 100%; justify-content: flex-start; }
        .timer { background: var(--card); border-radius: 14px; padding: 10px 14px; display: grid; gap: 6px; min-width: 220px; border: 1px solid var(--border); }
        .timer .row { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--muted); }
        .timer button { border: none; border-radius: 10px; padding: 6px 10px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; }
        .timer .note { font-size: 0.8rem; color: #f59e0b; min-height: 18px; }
        .hero { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 18px; box-shadow: var(--soft-shadow); display: grid; gap: 10px; }
        .hero h2 { font-size: clamp(1.4rem, 2.6vw, 2rem); }
        .hero p { color: var(--muted); }
        .tag-legend { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-top: 6px; }
        .tag-chip { background: rgba(148,163,184,0.12); border: 1px solid var(--border); border-radius: 10px; padding: 6px 8px; font-size: 0.78rem; color: var(--ink); }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .stat { background: rgba(148,163,184,0.12); border-radius: 12px; padding: 8px; text-align: center; }
        .stat strong { display: block; font-size: 1.2rem; }
        .stat span { color: var(--muted); font-size: 0.82rem; }
        .message { min-height: 24px; font-weight: 700; text-align: center; color: var(--muted); }
        .message.success { color: var(--success); }
        .message.error { color: var(--danger); }
        .board { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .column { background: rgba(255, 255, 255, 0.65); border-radius: var(--radius-lg); padding: 16px; box-shadow: var(--soft-shadow); min-width: 0; }
        .column h3 { margin-bottom: 10px; font-size: 1rem; }
        .phrase-list { display: flex; flex-direction: column; gap: 10px; }
        .phrase-card {
            padding: 12px;
            background: var(--card);
            border-radius: var(--radius-md);
            cursor: pointer;
            border: 1px solid transparent;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 8px;
        }
        .phrase-card.selected { border-color: var(--accent); background: var(--soft); }
        .phrase-card.matched { border-color: var(--success); background: rgba(22,163,74,0.14); opacity: 0.8; pointer-events: none; }
        .phrase-card.wrong { border-color: var(--danger); background: rgba(220,38,38,0.12); }
        .phrase-content { display: grid; gap: 6px; flex: 1; min-width: 0; }
        .phrase-text { font-weight: 700; }
        .phrase-grammar { font-size: 0.76rem; line-height: 1.3; color: var(--ink); background: rgba(43,114,255,0.12); border-radius: 8px; padding: 6px; word-break: break-word; }
        .phrase-literal { display: none; font-size: 0.8rem; color: var(--ink); background: rgba(109,75,255,0.16); border-radius: 8px; padding: 6px; }
        .phrase-card.flipped .phrase-literal { display: block; }
        .meta-badge { display: inline-block; font-size: 0.68rem; font-weight: 700; padding: 2px 6px; border-radius: 999px; margin-right: 4px; background: rgba(240,147,251,0.28); color: #7c275e; }
        .card-icons { display: flex; gap: 5px; }
        .icon-btn { cursor: pointer; font-size: 0.95rem; opacity: 0.75; }
        .controls { display: flex; justify-content: center; gap: 10px; }
        .controls button { border: none; border-radius: 12px; padding: 10px 14px; cursor: pointer; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; }
        .settings-fab { position: fixed; right: 22px; bottom: 22px; width: 52px; height: 52px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; display: grid; place-items: center; box-shadow: var(--shadow); cursor: pointer; z-index: 60; }
        .settings-panel { position: fixed; right: 22px; bottom: 88px; width: min(320px, 90vw); background: var(--card); border-radius: 18px; border: 1px solid var(--border); box-shadow: var(--shadow); padding: 14px; display: none; flex-direction: column; gap: 12px; z-index: 60; }
        .settings-panel.open { display: flex; }
        .settings-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .settings-row select { border: 1px solid var(--border); background: var(--card); color: var(--ink); padding: 8px 10px; border-radius: 10px; font-weight: 600; }
        .debug-box { background: rgba(148, 163, 184, 0.12); padding: 10px; border-radius: 10px; font-size: 0.85rem; color: var(--muted); }
        .settings-actions { display: flex; gap: 8px; }
        .settings-actions button { border: none; border-radius: 10px; padding: 8px 12px; font-weight: 600; cursor: pointer; background: rgba(148, 163, 184, 0.2); color: var(--ink); }
        @media (max-width: 900px) { .stats { grid-template-columns: repeat(2,1fr); } }
        @media (max-width: 760px) { .board { grid-template-columns: 1fr 1fr; gap: 10px; } body { padding: 12px; } }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <a class="brand" href="index.html">
                <img src="apple-touch-icon.png" alt="DeutscheTag logo">
                <div>
                    <h1>DeutscheTag</h1>
                    <div style="color: var(--muted); font-size: 0.9rem;">Sentence match</div>
                </div>
            </a>
            <button class="menu-toggle" id="menuToggle" aria-label="Open navigation"><span></span><span></span><span></span></button>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="german_matching_game.html">Vocabulary</a>
                <a class="active" href="german_grammar_game.html">Sentence Match</a>
                <a href="typing_practice.html">Typing</a>
                <a href="dictionary.html">Dictionary</a>
                <a href="fundamentals.html">Time & Alphabet</a>
                <a href="number_time_match.html">Number/Time Match</a>
                <a href="grammar_guide.html">Grammar Guide</a>
                <a href="verb_forms.html">Verb Forms</a>
                <a href="article_prefix_practice.html">Articles</a>
                <a href="falling_match.html">Falling Match</a>
                <a href="german_2048.html">2048</a>
                <a href="translate_parse.html">Translate</a>
            </div>
            <div class="nav-actions">
                <div class="timer" id="timerWidget">
                    <div class="row"><span>Session</span><strong id="sessionTime">00:00</strong></div>
                    <div class="row"><span>Today</span><strong id="todayTime">00:00</strong></div>
                    <div class="row"><span>Streak</span><strong id="streakCount">0 days</strong></div>
                    <div class="note" id="timerNote"></div>
                    <button id="timerToggle">Start</button>
                </div>
            </div>
        </nav>

        <section class="hero">
            <h2>Sentence Match</h2>
            <p>Practice spoken vs written and formal vs informal German. Use the hint icon to see sentence layout logic.</p>
            <div class="tag-legend" aria-label="Grammar tag key">
                <div class="tag-chip"><strong>SCONJ</strong>: subordinate conjunction (e.g., <em>obwohl</em>)</div>
                <div class="tag-chip"><strong>CONJ</strong>: coordinating conjunction</div>
                <div class="tag-chip"><strong>PRON</strong>: pronoun</div>
                <div class="tag-chip"><strong>ART</strong>: article</div>
                <div class="tag-chip"><strong>POSS</strong>: possessive determiner</div>
                <div class="tag-chip"><strong>PREP</strong>: preposition</div>
                <div class="tag-chip"><strong>VFIN</strong>: finite verb</div>
                <div class="tag-chip"><strong>VINF</strong>: infinitive verb</div>
                <div class="tag-chip"><strong>VMOD</strong>: modal verb</div>
                <div class="tag-chip"><strong>NOUN</strong>: noun</div>
                <div class="tag-chip"><strong>ADV</strong>: adverb</div>
                <div class="tag-chip"><strong>NEG</strong>: negation word</div>
                <div class="tag-chip"><strong>PART</strong>: particle</div>
                <div class="tag-chip"><strong>LEX</strong>: other lexical word not in tagged list</div>
            </div>
            <div class="stats">
                <div class="stat"><strong id="roundNumber">1</strong><span>Round</span></div>
                <div class="stat"><strong id="roundScore">0/10</strong><span>This round</span></div>
                <div class="stat"><strong id="totalScore">0</strong><span>Correct</span></div>
                <div class="stat"><strong id="accuracy">0%</strong><span>Accuracy</span></div>
            </div>
            <div class="message" id="message"></div>
        </section>

        <section class="board">
            <div class="column">
                <h3>Deutsch</h3>
                <div class="phrase-list" id="germanPhrases"></div>
            </div>
            <div class="column">
                <h3>English</h3>
                <div class="phrase-list" id="englishPhrases"></div>
            </div>
        </section>

        <div class="controls">
            <button id="listenBtn">Sound</button>
            <button id="hintBtn">Hint</button>
            <button id="nextBtn">Next round</button>
            <button id="homeBtnFooter">Home</button>
        </div>
    </div>

    <script>
        const phraseData = [
            { de: 'Guten Morgen, Frau Weber.', en: 'Good morning, Ms Weber.', lit: 'Good morning Ms Weber', register: 'spoken', formality: 'formal', grammarHint: 'Greeting first, then title + surname in formal speech.' },
            { de: 'Hallo Tom, hast du heute Abend Zeit?', en: 'Hi Tom, do you have time this evening?', lit: 'Hello Tom have you today evening time', register: 'spoken', formality: 'informal', grammarHint: 'Informal question uses verb-first after greeting.' },
            { de: 'Entschuldigung, wo ist der Bahnhof?', en: 'Excuse me, where is the train station?', lit: 'Excuse where is the station', register: 'spoken', formality: 'both', grammarHint: 'W-question: question word in position 1, verb in position 2.' },
            { de: 'Ich hÃ¤tte gern einen Kaffee, bitte.', en: 'I would like a coffee, please.', lit: 'I would-have gladly a coffee please', register: 'spoken', formality: 'formal', grammarHint: 'Polite request uses Konjunktiv II form "hÃ¤tte gern".' },
            { de: 'Kann ich mit Karte bezahlen?', en: 'Can I pay by card?', lit: 'Can I with card pay', register: 'spoken', formality: 'both', grammarHint: 'Modal verb first in yes/no question; infinitive at sentence end.' },
            { de: 'Wir treffen uns um halb acht am Eingang.', en: 'We meet at half past seven at the entrance.', lit: 'We meet us at half eight at-the entrance', register: 'spoken', formality: 'informal', grammarHint: 'Time expression before place in the middle field.' },
            { de: 'Der Zug nach Berlin hat zehn Minuten VerspÃ¤tung.', en: 'The train to Berlin is ten minutes late.', lit: 'The train to Berlin has ten minutes delay', register: 'written', formality: 'neutral', grammarHint: 'Main clause with verb in position 2 and accusative object.' },
            { de: 'Ich komme spÃ¤ter, weil ich noch arbeite.', en: 'I am coming later because I am still working.', lit: 'I come later because I still work', register: 'both', formality: 'both', grammarHint: 'In a weil-clause, finite verb goes to the end.' },
            { de: 'Wenn du mÃ¶chtest, reserviere ich einen Tisch.', en: 'If you want, I will reserve a table.', lit: 'If you want reserve I a table', register: 'both', formality: 'informal', grammarHint: 'Subordinate clause first, then main clause starts with verb.' },
            { de: 'Bitte schicken Sie mir die Unterlagen per E-Mail.', en: 'Please send me the documents by email.', lit: 'Please send you me the documents by email', register: 'written', formality: 'formal', grammarHint: 'Formal command with "Sie"; dative pronoun before accusative object.' },
            { de: 'Ich habe den Termin auf morgen verschoben.', en: 'I postponed the appointment until tomorrow.', lit: 'I have the appointment to tomorrow moved', register: 'written', formality: 'neutral', grammarHint: 'Perfect tense frame: auxiliary in position 2, participle at the end.' },
            { de: 'Das Formular ist noch nicht vollstÃ¤ndig.', en: 'The form is still not complete.', lit: 'The form is still not complete', register: 'written', formality: 'formal', grammarHint: 'Negation with "nicht" before adjective phrase.' },
            { de: 'KÃ¶nnten Sie mir bitte kurz helfen?', en: 'Could you help me briefly, please?', lit: 'Could you me please briefly help', register: 'spoken', formality: 'formal', grammarHint: 'Polite modal question + infinitive at clause end.' },
            { de: 'Ich freue mich auf das Treffen am Freitag.', en: 'I am looking forward to the meeting on Friday.', lit: 'I rejoice myself on the meeting on Friday', register: 'written', formality: 'neutral', grammarHint: 'Reflexive verb with fixed preposition "auf" + accusative.' },
            { de: 'Darf ich hier kurz warten?', en: 'May I wait here briefly?', lit: 'May I here briefly wait', register: 'spoken', formality: 'both', grammarHint: 'Permission question with modal verb first.' },
            { de: 'Seit zwei Jahren lerne ich Deutsch.', en: 'I have been learning German for two years.', lit: 'Since two years learn I German', register: 'both', formality: 'both', grammarHint: 'Time phrase in position 1, finite verb remains in position 2.' },
            { de: 'Das Hotel ist kleiner als auf den Fotos.', en: 'The hotel is smaller than in the photos.', lit: 'The hotel is smaller than on the photos', register: 'both', formality: 'neutral', grammarHint: 'Comparative with "als" for inequality.' },
            { de: 'Obwohl es regnet, gehen wir zu FuÃŸ.', en: 'Although it is raining, we are going on foot.', lit: 'Although it rains go we on foot', register: 'both', formality: 'neutral', grammarHint: 'Subordinate clause first with verb-final; main clause starts with verb.' },
            { de: 'Sehr geehrte Damen und Herren, ich bitte um RÃ¼ckmeldung.', en: 'Dear Sir or Madam, I ask for a reply.', lit: 'Very honored ladies and gentlemen I ask for feedback', register: 'written', formality: 'formal', grammarHint: 'Formal letter opening + concise request clause.' },
            { de: 'Liebe Anna, vielen Dank fÃ¼r deine Nachricht.', en: 'Dear Anna, many thanks for your message.', lit: 'Dear Anna many thanks for your message', register: 'written', formality: 'informal', grammarHint: 'Informal letter opening uses first name and possessive dein/deine.' },
            { de: 'Das hier ist unsere WohnkÃ¼che.', en: 'This is our kitchen-living room.', lit: 'This here is our living kitchen', register: 'spoken', formality: 'informal', grammarHint: 'Demonstrative phrase first, then finite verb in second position.' },
            { de: 'Hier liegen noch seine Spielsachen.', en: 'His toys are still lying here.', lit: 'Here lie still his toys', register: 'spoken', formality: 'informal', grammarHint: 'Location adverb in position 1, finite verb in position 2.' },
            { de: 'Die Torte steht hinter dem Kuchen.', en: 'The cake stands behind the pie.', lit: 'The cake stands behind the cake', register: 'both', formality: 'neutral', grammarHint: 'Local preposition with dative case after static location.' },
            { de: 'Bitte Ã¼berweisen Sie das Geld bis zum 31. Dezember.', en: 'Please transfer the money by 31 December.', lit: 'Please transfer you the money by 31 December', register: 'written', formality: 'formal', grammarHint: 'Formal imperative with Sie-form + accusative object.' },
            { de: 'Hier darf man nicht rauchen.', en: 'Smoking is not allowed here.', lit: 'Here may one not smoke', register: 'spoken', formality: 'both', grammarHint: 'Modal verb in second position, infinitive at clause end, negation before infinitive.' },
            { de: 'Wir mÃ¼ssen heute lange arbeiten.', en: 'We have to work long today.', lit: 'We must today long work', register: 'both', formality: 'both', grammarHint: 'Modal sentence: finite modal in position 2 and lexical infinitive at end.' },
            { de: 'Du sollst dein Zimmer aufrÃ¤umen.', en: 'You should tidy your room.', lit: 'You should your room tidy up', register: 'spoken', formality: 'informal', grammarHint: 'Modal construction with accusative object before infinitive.' },
            { de: 'Als Kind konnte ich nicht Auto fahren.', en: 'As a child I could not drive a car.', lit: 'As child could I not car drive', register: 'both', formality: 'neutral', grammarHint: 'Time phrase fronted; finite modal remains in second position.' }
        ];

        const POS_LEXICON = {
            ich: 'PRON', du: 'PRON', er: 'PRON', sie: 'PRON', wir: 'PRON', ihr: 'PRON', man: 'PRON',
            mich: 'PRON', mir: 'PRON', dich: 'PRON', dir: 'PRON', uns: 'PRON', euch: 'PRON',
            der: 'ART', die: 'ART', das: 'ART', den: 'ART', dem: 'ART', des: 'ART', ein: 'ART', eine: 'ART', einen: 'ART', einem: 'ART',
            mein: 'POSS', meine: 'POSS', dein: 'POSS', deine: 'POSS', ihr: 'POSS', unsere: 'POSS',
            und: 'CONJ', aber: 'CONJ', oder: 'CONJ', denn: 'CONJ', weil: 'SCONJ', wenn: 'SCONJ', obwohl: 'SCONJ', ob: 'SCONJ',
            nicht: 'NEG', heute: 'ADV', morgen: 'ADV', hier: 'ADV', noch: 'ADV',
            zu: 'PREP', auf: 'PREP', mit: 'PREP', bei: 'PREP', fÃ¼r: 'PREP', nach: 'PREP', in: 'PREP', am: 'PREP', im: 'PREP', um: 'PREP',
            kann: 'VMOD', kannst: 'VMOD', kÃ¶nnen: 'VMOD', kÃ¶nnte: 'VMOD', kÃ¶nnten: 'VMOD', muss: 'VMOD', musst: 'VMOD', dÃ¼rfen: 'VMOD', darf: 'VMOD',
            ist: 'VFIN', sind: 'VFIN', habe: 'VFIN', hast: 'VFIN', hat: 'VFIN', bin: 'VFIN', komme: 'VFIN', lernen: 'VINF',
            bitte: 'PART'
        };

        function tagWord(raw) {
            const cleaned = raw.toLowerCase().replace(/[.,!?;:]/g, '');
            if (!cleaned) return '';
            if (POS_LEXICON[cleaned]) return `${raw}(${POS_LEXICON[cleaned]})`;
            if (cleaned.match(/(en|ern|eln)$/)) return `${raw}(VINF)`;
            if (cleaned.match(/(e|st|t)$/)) return `${raw}(VFIN)`;
            if (/^[A-ZÃ„Ã–Ãœ]/.test(raw)) return `${raw}(NOUN)`;
            return `${raw}(LEX)`;
        }

        function annotateSentence(sentence) { return sentence.split(/\s+/).map(tagWord).join(' '); }

        let selectedGerman = null;
        let selectedEnglish = null;
        let roundMatches = 0;
        let totalCorrect = 0;
        let totalAttempts = 0;
        let roundNumber = 1;
        let used = [];
        let currentRoundItems = [];
        let hintStep = 0;
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const audioCtx = AudioCtx ? new AudioCtx() : null;

        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function nextSet(count) {
            const available = phraseData.filter((_, i) => !used.includes(i));
            if (available.length < count) used = [];
            const pool = phraseData.map((x, i) => ({ x, i })).filter((obj) => !used.includes(obj.i));
            const picked = shuffle(pool).slice(0, count);
            picked.forEach((p) => used.push(p.i));
            return picked.map((p) => p.x);
        }

        function speakText(text, lang, e) {
            if (e) e.stopPropagation();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(() => {});
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang === 'de' ? 'de-DE' : 'en-US';
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }
        }

        function playTone(ok) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume().catch(() => {});
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = 'triangle';
            o.frequency.value = ok ? 740 : 230;
            g.gain.value = 0.001;
            o.connect(g);
            g.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            g.gain.exponentialRampToValueAtTime(0.07, now + 0.01);
            g.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
            o.start(now);
            o.stop(now + 0.21);
        }

        function renderCard(item, isGerman) {
            const card = document.createElement('div');
            card.className = 'phrase-card';
            const content = document.createElement('div');
            content.className = 'phrase-content';

            const text = document.createElement('span');
            text.className = 'phrase-text';
            text.textContent = isGerman ? item.de : item.en;

            const badges = document.createElement('div');
            badges.innerHTML = `<span class="meta-badge">${item.register}</span><span class="meta-badge">${item.formality}</span>`;

            const grammar = document.createElement('span');
            grammar.className = 'phrase-grammar';
            grammar.textContent = annotateSentence(item.de);

            const hint = document.createElement('span');
            hint.className = 'phrase-literal';
            hint.textContent = `Hint: ${item.grammarHint} | Literal: ${item.lit}`;

            content.appendChild(text);
            content.appendChild(badges);
            content.appendChild(grammar);
            content.appendChild(hint);

            const icons = document.createElement('div');
            icons.className = 'card-icons';
            const speaker = document.createElement('span');
            speaker.className = 'icon-btn';
            speaker.textContent = 'ðŸ”Š';
            speaker.onclick = (e) => speakText(isGerman ? item.de : item.en, isGerman ? 'de' : 'en', e);

            const bulb = document.createElement('span');
            bulb.className = 'icon-btn';
            bulb.textContent = 'ðŸ’¡';
            bulb.onclick = (e) => { e.stopPropagation(); card.classList.toggle('flipped'); };

            icons.appendChild(speaker);
            icons.appendChild(bulb);
            card.appendChild(content);
            card.appendChild(icons);
            card.dataset.de = item.de;
            card.dataset.en = item.en;
            return card;
        }

        function loadRound() {
            const message = document.getElementById('message');
            const deList = document.getElementById('germanPhrases');
            const enList = document.getElementById('englishPhrases');
            const round = nextSet(10);
            currentRoundItems = round;
            const shuffledEn = shuffle(round);

            roundMatches = 0;
            hintStep = 0;
            selectedGerman = null;
            selectedEnglish = null;
            message.textContent = '';
            deList.innerHTML = '';
            enList.innerHTML = '';

            round.forEach((item) => {
                const card = renderCard(item, true);
                card.onclick = () => selectGerman(card);
                deList.appendChild(card);
            });

            shuffledEn.forEach((item) => {
                const card = renderCard(item, false);
                card.onclick = () => selectEnglish(card);
                enList.appendChild(card);
            });
            updateStats();
        }

        function firstUnmatchedGermanCard() {
            return [...document.querySelectorAll('#germanPhrases .phrase-card')].find((c) => !c.classList.contains('matched')) || null;
        }

        function globalListen() {
            const card = selectedGerman || firstUnmatchedGermanCard();
            if (!card) return;
            speakText(card.dataset.de, 'de');
        }

        function globalHint() {
            const card = selectedGerman || firstUnmatchedGermanCard();
            if (!card) return;
            const item = currentRoundItems.find((x) => x.de === card.dataset.de);
            const message = document.getElementById('message');
            if (!item) return;
            hintStep += 1;
            if (hintStep === 1) {
                message.textContent = `Hint 1: English starts with "${item.en.charAt(0)}".`;
            } else if (hintStep === 2) {
                message.textContent = `Hint 2: ${item.grammarHint}`;
            } else {
                card.classList.add('flipped');
                message.textContent = 'Hint 3: literal and structure reveal opened.';
            }
            message.className = 'message';
        }

        function selectGerman(card) {
            if (card.classList.contains('matched')) return;
            document.querySelectorAll('#germanPhrases .phrase-card').forEach((c) => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedGerman = card;
            checkMatch();
        }

        function selectEnglish(card) {
            if (card.classList.contains('matched')) return;
            document.querySelectorAll('#englishPhrases .phrase-card').forEach((c) => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedEnglish = card;
            checkMatch();
        }

        function checkMatch() {
            if (!selectedGerman || !selectedEnglish) return;
            const message = document.getElementById('message');
            totalAttempts += 1;
            if (selectedGerman.dataset.en === selectedEnglish.dataset.en) {
                selectedGerman.classList.add('matched');
                selectedEnglish.classList.add('matched');
                selectedGerman.classList.remove('selected');
                selectedEnglish.classList.remove('selected');
                roundMatches += 1;
                totalCorrect += 1;
                message.textContent = 'Correct.';
                message.className = 'message success';
                playTone(true);
                selectedGerman = null;
                selectedEnglish = null;
            } else {
                selectedGerman.classList.add('wrong');
                selectedEnglish.classList.add('wrong');
                message.textContent = 'Try again.';
                message.className = 'message error';
                playTone(false);
                setTimeout(() => {
                    if (selectedGerman) selectedGerman.classList.remove('wrong', 'selected');
                    if (selectedEnglish) selectedEnglish.classList.remove('wrong', 'selected');
                    selectedGerman = null;
                    selectedEnglish = null;
                    message.textContent = '';
                }, 700);
            }
            updateStats();
        }

        function updateStats() {
            document.getElementById('roundNumber').textContent = roundNumber;
            document.getElementById('roundScore').textContent = `${roundMatches}/10`;
            document.getElementById('totalScore').textContent = totalCorrect;
            const acc = totalAttempts ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
            document.getElementById('accuracy').textContent = `${acc}%`;
        }

        document.getElementById('nextBtn').addEventListener('click', () => {
            roundNumber += 1;
            loadRound();
        });
        document.getElementById('listenBtn').addEventListener('click', globalListen);
        document.getElementById('hintBtn').addEventListener('click', globalHint);
        document.getElementById('homeBtnFooter').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        loadRound();
    </script>
    <script src="menu-settings.js"></script>

    <div class="settings-fab" id="settingsFab" aria-label="Open settings">âš™</div>
    <div class="settings-panel" id="settingsPanel">
        <h4>Settings</h4>
        <div class="settings-row">
            <label for="settingsTheme" style="font-weight:600;">Theme</label>
            <select id="settingsTheme">
                <option value="system">System</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
        </div>
        <div class="debug-box" id="deeplDebug">DeepL debug available on Translate page.</div>
        <div class="settings-actions">
            <button id="debugTestBtn">Test DeepL</button>
            <button id="debugClearBtn">Clear cache</button>
        </div>
        <div class="settings-note">Theme settings apply across all pages.</div>
    </div>
</body>
</html>
