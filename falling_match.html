<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>DeutscheTag | Falling Match</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&family=Playfair+Display:wght@500;600&family=Press+Start+2P&display=swap');

        :root {
            --bg: linear-gradient(135deg, #f7f4ff 0%, #f9f6ef 45%, #eef5ff 100%);
            --card: #ffffff;
            --ink: #0f172a;
            --muted: #64748b;
            --accent: #6d4bff;
            --accent-2: #2b72ff;
            --soft: rgba(109, 75, 255, 0.12);
            --shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
            --soft-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
            --radius-lg: 26px;
            --radius-md: 18px;
            --nav-bg: rgba(255, 255, 255, 0.82);
            --border: rgba(148, 163, 184, 0.2);
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body.theme-dark {
            --bg: linear-gradient(135deg, #0b1120 0%, #0f172a 45%, #111827 100%);
            --card: #101827;
            --ink: #e2e8f0;
            --muted: #94a3b8;
            --accent: #8b5cf6;
            --accent-2: #38bdf8;
            --soft: rgba(139, 92, 246, 0.18);
            --shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
            --soft-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
            --nav-bg: rgba(15, 23, 42, 0.82);
            --border: rgba(148, 163, 184, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            min-height: 100vh;
            background: var(--bg);
            font-family: 'Manrope', 'Segoe UI', sans-serif;
            color: var(--ink);
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(109, 75, 255, 0.18), transparent 55%),
                        radial-gradient(circle at 80% 10%, rgba(43, 114, 255, 0.15), transparent 45%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .nav {
            position: relative;
            position: relative;
            background: var(--nav-bg);
            border-radius: var(--radius-lg);
            padding: 12px 18px;
            box-shadow: var(--soft-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
        }

        .brand {
    text-decoration: none;
    color: inherit;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand img {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            box-shadow: 0 8px 18px rgba(109, 75, 255, 0.2);
        }

        .brand h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.2rem, 2.4vw, 1.8rem);
        }

                                        
        .nav-links {
            display: none;
            position: absolute;
            right: 16px;
            top: 68px;
            flex-direction: column;
            align-items: stretch;
            background: var(--card);
            padding: 12px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--soft-shadow);
            z-index: 35;
            min-width: 180px;
        }

        .nav-links.open { display: flex; }

        .nav-links a {
            text-decoration: none;
            color: var(--muted);
            padding: 8px 12px;
            border-radius: 999px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .nav-links a.active,
        .nav-links a:hover {
            background: var(--soft);
            color: var(--accent);
        }
        .nav-actions {
            margin-right: 68px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-select {
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--ink);
            padding: 8px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .timer {
            background: var(--card);
            border-radius: 14px;
            padding: 10px 14px;
            display: grid;
            gap: 6px;
            min-width: 220px;
            border: 1px solid var(--border);
        }

        .timer .row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .timer strong { color: var(--ink); }

        .timer button {
            border: none;
            border-radius: 10px;
            padding: 6px 10px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: white;
            transition: transform 0.2s ease;
        }

        .timer button:hover { animation: bounce 0.6s; }

        .timer .note {
            font-size: 0.8rem;
            color: var(--warning);
            min-height: 18px;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .panel {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            display: grid;
            gap: 12px;
        }

        .panel h2 { font-size: 1.5rem; }
        .panel p { color: var(--muted); }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .controls select,
        .controls button {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--ink);
            font-weight: 600;
        }

        .controls button {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: white;
            border: none;
            cursor: pointer;
        }

        .controls button:hover { animation: bounce 0.6s; }

        .stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            color: var(--muted);
        }

        .arcade {
            background: #05050a;
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            border: 2px solid #1f2937;
            position: relative;
            overflow: hidden;
        }

        .arcade::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.04) 2px, transparent 2px, transparent 6px);
            pointer-events: none;
        }

        .arcade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            color: #34d399;
            font-size: 0.7rem;
            margin-bottom: 10px;
        }

        .arena {
            position: relative;
            height: 520px;
            border-radius: 14px;
            background: radial-gradient(circle at top, rgba(56,189,248,0.2), transparent 60%), #02040f;
            overflow: hidden;
            border: 1px solid rgba(56,189,248,0.4);
            touch-action: none;
        }

        .lane-grid {
            position: absolute;
            inset: 0;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            pointer-events: none;
        }

        .lane-grid div {
            border-right: 1px dashed rgba(56,189,248,0.2);
        }

        .chip {
            position: absolute;
            padding: 6px 8px;
            border-radius: 6px;
            background: #0f172a;
            box-shadow: 0 0 10px rgba(56,189,248,0.5);
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            border: 2px solid transparent;
            color: #e2e8f0;
            min-width: 70px;
            text-align: center;
            transition: transform 0.1s ease;
        }

        .chip.bumped {
            animation: bump 0.2s ease;
        }

        @keyframes bump {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(2deg); }
            100% { transform: rotate(0deg); }
        }

        .chip .tag {
            display: block;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5rem;
            margin-bottom: 4px;
            color: #22c55e;
        }

        .chip.selected { border-color: #facc15; }
        .chip.matched { border-color: #22c55e; box-shadow: 0 0 16px rgba(34,197,94,0.8); }

        .message {
            text-align: center;
            font-weight: 600;
            min-height: 26px;
            color: var(--muted);
        }

        @media (max-width: 900px) {
            .arena { height: 560px; }
        }

        @media (max-width: 820px) {
            .nav { justify-content: center; }
            .timer { width: 100%; }
        }

        @media (max-width: 640px) {
            body { padding: 12px; }
            .nav-actions { width: 100%; justify-content: space-between; }
        }
            .nav-actions { width: 100%; justify-content: space-between; }
        }
    
                .settings-panel {
            position: fixed;
            right: 22px;
            bottom: 88px;
            width: min(320px, 90vw);
            background: var(--card);
            border-radius: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 14px;
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 50;
        }

        .settings-panel.open { display: flex; }

        .settings-panel h4 { font-size: 1rem; }
        .settings-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .settings-row select {
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--ink);
            padding: 8px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        .settings-note { font-size: 0.85rem; color: var(--muted); }
        .debug-box { background: rgba(148, 163, 184, 0.12); padding: 10px; border-radius: 10px; font-size: 0.85rem; color: var(--muted); }
        .settings-actions { display: flex; gap: 8px; }
        .settings-actions button {
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(148, 163, 184, 0.2);
            color: var(--ink);
        }
    
        .menu-toggle {
            display: inline-flex;
            border: none;
            background: rgba(148, 163, 184, 0.2);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            gap: 4px;
            flex-direction: column;
            position: absolute;
            right: 16px;
            top: 16px;
            z-index: 40;
        }

        .menu-toggle span {
            width: 20px;
            height: 2px;
            background: var(--ink);
            border-radius: 999px;
            display: block;
        }

        .nav { position: relative; }

                        .nav-actions { margin-right: 68px; }

        .settings-fab {
            position: fixed;
            right: 22px;
            bottom: 22px;
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: white;
            display: grid;
            place-items: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 60;
        }

        .settings-panel {
            position: fixed;
            right: 22px;
            bottom: 88px;
            width: min(320px, 90vw);
            background: var(--card);
            border-radius: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 14px;
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 60;
        }

        .settings-panel.open { display: flex; }

        .settings-panel h4 { font-size: 1rem; }
        .settings-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .settings-row select {
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--ink);
            padding: 8px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        .settings-note { font-size: 0.85rem; color: var(--muted); }
        .debug-box { background: rgba(148, 163, 184, 0.12); padding: 10px; border-radius: 10px; font-size: 0.85rem; color: var(--muted); }
        .settings-actions { display: flex; gap: 8px; }
        .settings-actions button {
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(148, 163, 184, 0.2);
            color: var(--ink);
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <a class="brand" href="index.html">
                <img src="apple-touch-icon.png" alt="DeutscheTag logo">
                <div>
                    <h1>DeutscheTag</h1>
                    <div style="color: var(--muted); font-size: 0.9rem;">Falling match</div>
                </div>
            </a>
            <button class="menu-toggle" id="menuToggle" aria-label="Open navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="german_matching_game.html">Vocabulary</a>
                <a href="german_grammar_game.html">Sentence Match</a>
                <a href="typing_practice.html">Typing</a>
                <a href="dictionary.html">Dictionary</a>
                <a href="fundamentals.html">Time & Alphabet</a>
                <a href="number_time_match.html">Number/Time Match</a>
                <a href="grammar_guide.html">Grammar Guide</a>
                <a href="verb_forms.html">Verb Forms</a>
                <a href="article_prefix_practice.html">Articles</a>
                <a class="active" href="falling_match.html">Falling Match</a>
                            <a href="german_2048.html">2048</a>
                            <a href="translate_parse.html">Translate</a>
            </div>
            <div class="nav-actions">
                <div class="timer" id="timerWidget">
                    <div class="row"><span>Session</span><strong id="sessionTime">00:00</strong></div>
                    <div class="row"><span>Today</span><strong id="todayTime">00:00</strong></div>
                    <div class="row"><span>Streak</span><strong id="streakCount">0 days</strong></div>
                    <div class="note" id="timerNote"></div>
                    <button id="timerToggle">Start</button>
                </div>
            </div>
        </nav>

        <section class="panel">
            <h2>Falling Match (Arcade)</h2>
            <p>Classic Tetris-style lanes. Multiple words fall at once. Match the German + English pair before any chip hits the bottom.</p>
            <div class="controls">
                <select id="durationSelect">
                    <option value="30">30 seconds</option>
                    <option value="60">1 minute</option>
                    <option value="300">5 minutes</option>
                </select>
                <select id="difficultySelect">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                    <option value="impossible">Impossible</option>
                </select>
                <button id="startGame">Start game</button>
                <button id="pauseGame">Pause</button>
                <button id="hintBtn">Hint</button>
                <div class="stats">
                    <span>Time: <strong id="timeLeft">0</strong>s</span>
                    <span>Score: <strong id="score">0</strong></span>
                    <span>Matches: <strong id="matches">0</strong></span>
                </div>
            </div>
        </section>

        <div class="message" id="gameMessage"></div>

        <section class="arcade">
            <div class="arcade-header">
                <div>DEUTSCHETAG ARCADE</div>
                <div id="arcadeStatus">READY</div>
            </div>
            <div class="arena" id="arena">
                <div class="lane-grid">
                    <div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div>
                </div>
            </div>
        </section>
    </div>

    <script>


const wordPairs = [
            ['der', 'the (masculine)'], ['die', 'the (feminine/plural)'], ['das', 'the (neuter)'], ['und', 'and'], ['in', 'in'], ['sein', 'to be / his'],
            ['ein', 'a/an'], ['zu', 'to'], ['haben', 'to have'], ['ich', 'I'], ['werden', 'to become'], ['sie', 'she/they'], ['von', 'from/of'],
            ['nicht', 'not'], ['mit', 'with'], ['es', 'it'], ['auch', 'also'], ['auf', 'on'], ['für', 'for'], ['an', 'at/on'],
            ['er', 'he'], ['so', 'so'], ['dass', 'that'], ['können', 'can'], ['wie', 'how'], ['wir', 'we'], ['aber', 'but'],
            ['dann', 'then'], ['kommen', 'to come'], ['jetzt', 'now'], ['gehen', 'to go'], ['gut', 'good'], ['sehen', 'to see'],
            ['lassen', 'to let'], ['weil', 'because'], ['Zeit', 'time'], ['Weg', 'way/path'], ['Wasser', 'water'], ['Geld', 'money']
        ];

        const arena = document.getElementById('arena');
        const startGameBtn = document.getElementById('startGame');
        const pauseGameBtn = document.getElementById('pauseGame');
        const hintBtn = document.getElementById('hintBtn');
        const durationSelect = document.getElementById('durationSelect');
        const difficultySelect = document.getElementById('difficultySelect');
        const timeLeftEl = document.getElementById('timeLeft');
        const scoreEl = document.getElementById('score');
        const matchesEl = document.getElementById('matches');
        const gameMessage = document.getElementById('gameMessage');
        const arcadeStatus = document.getElementById('arcadeStatus');

        let chips = [];
        let selected = [];
        let score = 0;
        let matches = 0;
        let timeLeft = 0;
        let gameInterval = null;
        let spawnInterval = null;
        let animationFrame = null;
        let paused = false;
        let lastTime = null;
        let dragState = null;

        const difficultyConfig = {
            easy: { speed: 24, spawn: 2400, lanes: 6, batch: 2 },
            medium: { speed: 40, spawn: 1700, lanes: 7, batch: 3 },
            hard: { speed: 60, spawn: 1200, lanes: 8, batch: 4 },
            impossible: { speed: 80, spawn: 900, lanes: 8, batch: 5 }
        };

        function playTone() {}

        function createChip(text, pairId, lang, speed, laneIndex, lanes, yOverride = null) {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.innerHTML = `<span class="tag">${lang}</span>${text}`;
            chip.dataset.pairId = pairId;
            chip.dataset.lang = lang;
            chip.style.top = '8px';
            const laneWidth = arena.clientWidth / lanes;
            chip.style.left = `${laneIndex * laneWidth + 8}px`;
            chip.style.width = `${laneWidth - 16}px`;
            arena.appendChild(chip);

            const chipData = {
                el: chip,
                y: yOverride !== null ? yOverride : 8,
                speed,
                pairId,
                lane: laneIndex,
                lanes,
                dragging: false,
                dragMoved: false,
                ignoreClickUntil: 0
            };
            chips.push(chipData);
            chip.addEventListener('click', () => selectChip(chip));
            chip.addEventListener('pointerdown', (e) => beginDrag(e, chipData));
        }

        function selectChip(chip) {
            if (paused || timeLeft <= 0) return;
            const chipData = chips.find((c) => c.el === chip);
            if (chipData && chipData.ignoreClickUntil > Date.now()) return;
            if (selected.includes(chip)) return;
            chip.classList.add('selected');
            selected.push(chip);
            if (selected.length === 2) {
                const [first, second] = selected;
                if (first.dataset.pairId === second.dataset.pairId && first.dataset.lang !== second.dataset.lang) {
                    first.classList.add('matched');
                    second.classList.add('matched');
                    score += 5;
                    matches += 1;
                    gameMessage.textContent = 'Match confirmed.';
                    setTimeout(() => {
                        removeChip(first);
                        removeChip(second);
                    }, 150);
                } else {
                    score = Math.max(0, score - 2);
                    gameMessage.textContent = 'Not a match. Try again.';
                    first.classList.remove('selected');
                    second.classList.remove('selected');
                }
                selected = [];
                updateStats();
            }
        }

        function removeChip(chip) {
            chips = chips.filter((c) => c.el !== chip);
            chip.remove();
        }

        function getHintPair() {
            const groups = new Map();
            chips.forEach((chipData) => {
                const bucket = groups.get(chipData.pairId) || [];
                bucket.push(chipData);
                groups.set(chipData.pairId, bucket);
            });
            for (const [, group] of groups) {
                const de = group.find((g) => g.el.dataset.lang === 'DE');
                const en = group.find((g) => g.el.dataset.lang === 'EN');
                if (de && en) return { de, en };
            }
            return null;
        }

        function globalHint() {
            const pair = getHintPair();
            if (!pair) {
                gameMessage.textContent = 'No hint available right now.';
                return;
            }
            chips.forEach((c) => c.el.classList.remove('selected'));
            pair.de.el.classList.add('selected');
            pair.en.el.classList.add('selected');
            gameMessage.textContent = `Hint: match "${pair.de.el.textContent.replace(/^DE/, '').trim()}" with "${pair.en.el.textContent.replace(/^EN/, '').trim()}".`;
        }

        function beginDrag(event, chipData) {
            if (paused || timeLeft <= 0) return;
            event.preventDefault();
            chipData.dragging = true;
            chipData.dragMoved = false;
            chipData.el.setPointerCapture(event.pointerId);
            dragState = {
                chip: chipData,
                pointerId: event.pointerId,
                startY: event.clientY,
                startChipY: chipData.y
            };
        }

        function updateDrag(event) {
            if (!dragState || event.pointerId !== dragState.pointerId) return;
            const { chip, startY, startChipY } = dragState;
            const delta = event.clientY - startY;
            if (Math.abs(delta) > 6) chip.dragMoved = true;
            let nextY = Math.min(startChipY, startChipY + delta);
            const laneChips = chips.filter((c) => c.lane === chip.lane && c !== chip);
            laneChips.sort((a, b) => a.y - b.y);
            const above = laneChips.filter((c) => c.y < chip.y).slice(-1)[0];
            const minY = above ? above.y + (above.el.offsetHeight || 36) + 8 : -40;
            if (nextY < minY) nextY = minY;
            chip.y = nextY;
            chip.el.style.top = `${chip.y}px`;
        }

        function endDrag(event) {
            if (!dragState || event.pointerId !== dragState.pointerId) return;
            dragState.chip.dragging = false;
            if (dragState.chip.dragMoved) {
                dragState.chip.ignoreClickUntil = Date.now() + 250;
            }
            dragState.chip.el.releasePointerCapture(event.pointerId);
            dragState = null;
        }

        arena.addEventListener('pointermove', updateDrag);
        arena.addEventListener('pointerup', endDrag);
        arena.addEventListener('pointercancel', endDrag);
        arena.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        function getLaneTop(lane) {
            const laneChips = chips.filter((chip) => chip.lane === lane);
            if (laneChips.length === 0) return 0;
            return Math.min(...laneChips.map((chip) => chip.y));
        }

        function spawnBatch() {
            const config = difficultyConfig[difficultySelect.value];
            for (let i = 0; i < config.batch; i++) {
                const index = Math.floor(Math.random() * wordPairs.length);
                const pair = wordPairs[index];
                const laneIndex = Math.floor(Math.random() * config.lanes);
                const laneIndex2 = Math.floor(Math.random() * config.lanes);
                const topA = getLaneTop(laneIndex);
                const topB = getLaneTop(laneIndex2);
                const yA = -40;
                const yB = -40;
                createChip(pair[0], index, 'DE', config.speed + Math.random() * 8, laneIndex, config.lanes, yA);
                createChip(pair[1], index, 'EN', config.speed + Math.random() * 8, laneIndex2, config.lanes, yB);
            }
        }

        function updateChips(delta) {
            if (!Number.isFinite(delta)) return;
            const maxHeight = arena.clientHeight - 28;
            const lanes = Math.max(...chips.map((c) => c.lanes || 1), 1);
            for (let lane = 0; lane < lanes; lane++) {
                const laneChips = chips.filter((chip) => chip.lane === lane);
                laneChips.sort((a, b) => a.y - b.y);
                let lastBottom = -Infinity;
                laneChips.forEach((chip) => {
                    if (!chip.dragging) {
                        chip.y += chip.speed * delta;
                    }
                    const height = chip.el.offsetHeight || 36;
                    if (chip.y < lastBottom + 8) {
                        chip.y = lastBottom + 8;
                        chip.el.classList.remove('bumped');
                        void chip.el.offsetWidth;
                        chip.el.classList.add('bumped');
                    }
                    chip.el.style.top = `${chip.y}px`;
                    lastBottom = chip.y + height;
                    if (chip.y >= maxHeight) {
                        endGame('A word hit the bottom. Game over.');
                    }
                });
            }
        }

        function updateStats() {
            scoreEl.textContent = score;
            matchesEl.textContent = matches;
        }

        function startGame() {
            resetGame();
            timeLeft = Number(durationSelect.value);
            timeLeftEl.textContent = timeLeft;
            gameMessage.textContent = 'Focus and match calmly.';
            arcadeStatus.textContent = 'PLAYING';
            paused = false;
            pauseGameBtn.textContent = 'Pause';

            spawnBatch();
            const config = difficultyConfig[difficultySelect.value];
            spawnInterval = setInterval(spawnBatch, config.spawn);
            gameInterval = setInterval(() => {
                if (!paused) {
                    timeLeft -= 1;
                    timeLeftEl.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        endGame('Time is up. Take a short break or switch tools.');
                    }
                }
            }, 1000);
            lastTime = null;
            animationFrame = requestAnimationFrame(gameLoop);
        }

        function gameLoop(timestamp) {
            if (typeof timestamp !== 'number') {
                animationFrame = requestAnimationFrame(gameLoop);
                return;
            }
            if (lastTime === null) lastTime = timestamp;
            const delta = Math.min((timestamp - lastTime) / 1000, 0.05);
            lastTime = timestamp;
            if (timeLeft <= 0 || paused) {
                animationFrame = requestAnimationFrame(gameLoop);
                return;
            }
            updateChips(delta);
            animationFrame = requestAnimationFrame(gameLoop);
        }

        function togglePause() {
            if (timeLeft <= 0) return;
            paused = !paused;
            arcadeStatus.textContent = paused ? 'PAUSED' : 'PLAYING';
            pauseGameBtn.textContent = paused ? 'Resume' : 'Pause';
            gameMessage.textContent = paused ? 'Paused.' : 'Back in motion.';
        }

        function resetGame() {
            chips.forEach((chip) => chip.el.remove());
            chips = [];
            selected = [];
            score = 0;
            matches = 0;
            updateStats();
            clearInterval(spawnInterval);
            clearInterval(gameInterval);
            if (animationFrame) cancelAnimationFrame(animationFrame);
            spawnInterval = null;
            gameInterval = null;
            animationFrame = null;
            lastTime = null;
        }

        function endGame(message) {
            clearInterval(spawnInterval);
            clearInterval(gameInterval);
            if (animationFrame) cancelAnimationFrame(animationFrame);
            spawnInterval = null;
            gameInterval = null;
            animationFrame = null;
            timeLeft = 0;
            timeLeftEl.textContent = 0;
            arcadeStatus.textContent = 'GAME OVER';
            paused = false;
            pauseGameBtn.textContent = 'Pause';
            gameMessage.textContent = message;
            lastTime = null;
        }

        startGameBtn

        startGameBtn.addEventListener('click', startGame);
        pauseGameBtn.addEventListener('click', togglePause);
        hintBtn.addEventListener('click', globalHint);

    </script>
    <script src="menu-settings.js"></script>

    <div class="settings-fab" id="settingsFab" aria-label="Open settings">
        ⚙
    </div>
    <div class="settings-panel" id="settingsPanel">
        <h4>Settings</h4>
        <div class="settings-row">
            <label for="settingsTheme" style="font-weight:600;">Theme</label>
            <select id="settingsTheme">
                <option value="system">System</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
        </div>
        <div class="debug-box" id="deeplDebug">DeepL debug available on Translate page.</div>
        <div class="settings-actions">
            <button id="debugTestBtn">Test DeepL</button>
            <button id="debugClearBtn">Clear cache</button>
        </div>
        <div class="settings-note">Theme settings apply across all pages.</div>
    </div>

</body>
</html>
